---
{"dg-publish":true,"permalink":"/02.DevWiki/Sources/유니티 메인스레드/"}
---

**스레드** : CPU에서 실행되는 작업의 흐름
**메인스레드** : 프로그램의 핵심적인 부분들이 실행되는 스레드

## 유니티와 메인스레드

- 유니티 메인스레드에는 렌더링, 물리연산, 게임로직 등 엔진의 핵심적인 기능들을 실행시키는 **PlayerLoop**라는 루프 명령이 돌고 있다
- 게임 로직은 메인 스레드에서 수행, 많은 연산이 필요한 부분은 멀티스레드로 위임하는것이 일반적인 사용방식
    - 유니티 메인스레드에서 무거운 작업 수행시 화면이 멈춰버릴 수 있다
        - **PlayerLoop**를 메인스레드에서 담당하기 때문이다
        - 이 때 멀티스레드에서 해당 작업을 대신 수행하게 만들면 메인스레드는 본인의 작업에 집중할 수 있다

## 유니티 API기능에 접근하는건 반드시 메인스레드에서

- **유니티 API관련 동기화는 메인스레드**에서 실행된다
- 따라서 유니티의 **게임오브젝트, 컴포넌트등 유니티 API에 접근하는 작업은 반드시 메인스레드**에서 수행해야 함
    - 그렇지 않을 경우 예기치 못한 문제가 발생할 수 있음에 주의
- `Task.Run()`등을 사용해 **멀티스레드 내에서 UnityAPI를 호출**하면 **예외가 발생**한다!

## 멀티스레드에서 UnityAPI를 실행할 수는 없을까?

> 😁 UnityAPI를 멀티스레드에서 실행하는것이 아니라 **UnityAPI 관련 코드를 메인스레드에 넘겨주는 방식**을 사용하면 우회적으로 사용할 수 있다!

### MainThreadDispatcher 구현

* **MainThreadDispatcher라는 MonoBehaviour 객체**를 만들고 여기에 UnityAPI 관련 코드들을 위임하여 실행하도록 처리한다
* 원리는 간단하다, 원하는 **UnityAPI 관련 함수를 MainThreadDispatcher에 등록**한 뒤 MainThreadDispatcher측에선 Update문 등으로 이를 **감지하고 꺼내어 실행**하도록 만들면 된다, 그럼 **콜스택의 시작이 메인스레드**가 되므로 안전해진다.
* **대신 값을 반환받는 처리는 불가능**해지므로 **값 반환은 콜백 파라미터**등으로 간접적으로 구현해야하며 **이에 따라 코드가 조금 지저분**해지는 문제는 있다

### UniTask와 Awaitable

> **Unity에 특화**되도록 만든 **Task** 라고 봐도 좋다
> 비동기 함수 **중간에 메인스레드로, 멀티스레드 전환**이 가능해 코드를 더 유연하게 작성할 수 있다

- **UniTask는 서드파티 플러그인**, **Awaitable은 유니티에서 공식적으로 지원하는 비동기 클래스**이다
    - UniTask에 대해선 [[02.DevWiki/Sources/유니티 UniTask\|유니티 UniTask]] 참고
- **Awaitable**은 유니티 2023.1 버전부터 지원